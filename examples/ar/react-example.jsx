import React, { useState, useEffect } from 'react';
import { PrayerTimesSDK } from 'prayer-times-calculation';

// ูููู ููุงููุช ุงูุตูุงุฉ ุงูุฑุฆูุณู
const PrayerTimesApp = () => {
  const [location, setLocation] = useState({ lat: 24.7136, lng: 46.6753, timezone: 3 });
  const [options, setOptions] = useState({
    method: 'MWL',
    asrJurisdiction: 'Standard'
  });
  const [date, setDate] = useState(new Date());
  const [times, setTimes] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  // ุญุณุงุจ ููุงููุช ุงูุตูุงุฉ ุนูุฏ ุชุบููุฑ ุงููุฏุฎูุงุช
  useEffect(() => {
    calculateTimes();
  }, [location, options, date]);

  const calculateTimes = () => {
    try {
      setLoading(true);
      setError(null);

      const sdk = new PrayerTimesSDK(
        location.lat,
        location.lng,
        date,
        location.timezone,
        options
      );

      const calculatedTimes = sdk.getTimes();
      setTimes(calculatedTimes);
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  const getCurrentLocation = () => {
    if (!navigator.geolocation) {
      setError('ุชุญุฏูุฏ ุงููููุน ุงูุฌุบุฑุงูู ุบูุฑ ูุฏุนูู ูู ูุฐุง ุงููุชุตูุญ');
      return;
    }

    setLoading(true);
    navigator.geolocation.getCurrentPosition(
      (position) => {
        setLocation({
          lat: position.coords.latitude,
          lng: position.coords.longitude,
          timezone: -new Date().getTimezoneOffset() / 60
        });
        setLoading(false);
      },
      (err) => {
        setError('ุบูุฑ ูุงุฏุฑ ุนูู ุงูุญุตูู ุนูู ุงููููุน: ' + err.message);
        setLoading(false);
      }
    );
  };

  return (
    <div className="prayer-times-app" dir="rtl">
      <Header />
      <LocationInput
        location={location}
        onLocationChange={setLocation}
        onGetCurrentLocation={getCurrentLocation}
      />
      <OptionsPanel options={options} onOptionsChange={setOptions} />
      <DateSelector date={date} onDateChange={setDate} />

      {loading && <LoadingSpinner />}
      {error && <ErrorMessage message={error} />}
      {times && <PrayerTimesDisplay times={times} />}

      <MethodInfo currentMethod={options.method} />
    </div>
  );
};

// ูููู ุงูุฑุฃุณ
const Header = () => (
  <header className="header">
    <h1>๐ ุญุงุณุจุฉ ููุงููุช ุงูุตูุงุฉ</h1>
    <p>ููุงููุช ุตูุงุฉ ุฅุณูุงููุฉ ุฏูููุฉ ูุฃู ูููุน</p>
  </header>
);

// ูููู ุฅุฏุฎุงู ุงููููุน
const LocationInput = ({ location, onLocationChange, onGetCurrentLocation }) => {
  const handleChange = (field, value) => {
    onLocationChange({
      ...location,
      [field]: parseFloat(value) || 0
    });
  };

  return (
    <div className="location-input">
      <h3>๐ ุงููููุน</h3>
      <div className="input-group">
        <div className="input-field">
          <label>ุฎุท ุงูุนุฑุถ:</label>
          <input
            type="number"
            step="any"
            value={location.lat}
            onChange={(e) => handleChange('lat', e.target.value)}
            placeholder="ูุซุงู: 24.7136"
          />
        </div>
        <div className="input-field">
          <label>ุฎุท ุงูุทูู:</label>
          <input
            type="number"
            step="any"
            value={location.lng}
            onChange={(e) => handleChange('lng', e.target.value)}
            placeholder="ูุซุงู: 46.6753"
          />
        </div>
        <div className="input-field">
          <label>ุงูููุทูุฉ ุงูุฒูููุฉ (ุฅุฒุงุญุฉ UTC):</label>
          <input
            type="number"
            step="any"
            value={location.timezone}
            onChange={(e) => handleChange('timezone', e.target.value)}
            placeholder="ูุซุงู: 3"
          />
        </div>
      </div>
      <button onClick={onGetCurrentLocation} className="location-btn">
        ๐ฏ ุงุณุชุฎุฏู ูููุนู ุงูุญุงูู
      </button>
    </div>
  );
};

// ูููู ููุญุฉ ุงูุฎูุงุฑุงุช
const OptionsPanel = ({ options, onOptionsChange }) => {
  const [showCustomAngles, setShowCustomAngles] = useState(false);

  const handleMethodChange = (method) => {
    setShowCustomAngles(method === 'Custom');
    onOptionsChange({
      ...options,
      method,
      ...(method !== 'Custom' && { fajrAngle: undefined, ishaAngle: undefined })
    });
  };

  return (
    <div className="options-panel">
      <h3>โ๏ธ ุฎูุงุฑุงุช ุงูุญุณุงุจ</h3>

      <div className="input-field">
        <label>ุทุฑููุฉ ุงูุญุณุงุจ:</label>
        <select
          value={options.method}
          onChange={(e) => handleMethodChange(e.target.value)}
        >
          <option value="MWL">ุฑุงุจุทุฉ ุงูุนุงูู ุงูุฅุณูุงูู (MWL)</option>
          <option value="ISNA">ุงูุฌูุนูุฉ ุงูุฅุณูุงููุฉ ูุฃูุฑููุง ุงูุดูุงููุฉ (ISNA)</option>
          <option value="Egypt">ุงูููุฆุฉ ุงููุตุฑูุฉ ุงูุนุงูุฉ ูููุณุงุญุฉ</option>
          <option value="Makkah">ุฌุงูุนุฉ ุฃู ุงููุฑู (ููุฉ)</option>
          <option value="Karachi">ุฌุงูุนุฉ ุงูุนููู ุงูุฅุณูุงููุฉ (ูุฑุงุชุดู)</option>
          <option value="Custom">ุฒูุงูุง ูุฎุตุตุฉ</option>
        </select>
      </div>

      {showCustomAngles && (
        <div className="custom-angles">
          <div className="input-field">
            <label>ุฒุงููุฉ ุงููุฌุฑ (ุจุงูุฏุฑุฌุงุช):</label>
            <input
              type="number"
              step="any"
              value={options.fajrAngle || ''}
              onChange={(e) => onOptionsChange({
                ...options,
                fajrAngle: parseFloat(e.target.value)
              })}
              placeholder="ูุซุงู: 18"
            />
          </div>
          <div className="input-field">
            <label>ุฒุงููุฉ ุงูุนุดุงุก (ุจุงูุฏุฑุฌุงุช):</label>
            <input
              type="number"
              step="any"
              value={options.ishaAngle || ''}
              onChange={(e) => onOptionsChange({
                ...options,
                ishaAngle: parseFloat(e.target.value)
              })}
              placeholder="ูุซุงู: 17"
            />
          </div>
        </div>
      )}

      <div className="input-field">
        <label>ุญุณุงุจ ุงูุนุตุฑ:</label>
        <select
          value={options.asrJurisdiction}
          onChange={(e) => onOptionsChange({
            ...options,
            asrJurisdiction: e.target.value
          })}
        >
          <option value="Standard">ุงูุนุงุฏู (ุงูุดุงูุนู/ุงููุงููู/ุงูุญูุจูู)</option>
          <option value="Hanafi">ุงูุญููู</option>
        </select>
      </div>
    </div>
  );
};

// ูููู ุงุฎุชูุงุฑ ุงูุชุงุฑูุฎ
const DateSelector = ({ date, onDateChange }) => (
  <div className="date-selector">
    <h3>๐ ุงูุชุงุฑูุฎ</h3>
    <input
      type="date"
      value={date.toISOString().split('T')[0]}
      onChange={(e) => onDateChange(new Date(e.target.value))}
    />
  </div>
);

// ูููู ุนุฑุถ ููุงููุช ุงูุตูุงุฉ
const PrayerTimesDisplay = ({ times }) => {
  const prayerInfo = [
    { key: 'fajr', name: 'ุงููุฌุฑ', description: 'ุตูุงุฉ ุงููุฌุฑ', icon: '๐' },
    { key: 'sunrise', name: 'ุงูุดุฑูู', description: 'ุดุฑูู ุงูุดูุณ', icon: 'โ๏ธ' },
    { key: 'dhuhr', name: 'ุงูุธูุฑ', description: 'ุตูุงุฉ ุงูุธูุฑ', icon: '๐' },
    { key: 'asr', name: 'ุงูุนุตุฑ', description: 'ุตูุงุฉ ุงูุนุตุฑ', icon: '๐ค๏ธ' },
    { key: 'maghrib', name: 'ุงููุบุฑุจ', description: 'ุตูุงุฉ ุงููุบุฑุจ', icon: '๐' },
    { key: 'isha', name: 'ุงูุนุดุงุก', description: 'ุตูุงุฉ ุงูุนุดุงุก', icon: '๐' }
  ];

  return (
    <div className="prayer-times-display">
      <h3>๐ ููุงููุช ุงูุตูุงุฉ</h3>
      <div className="times-grid">
        {prayerInfo.map(prayer => (
          <div key={prayer.key} className="time-card">
            <div className="prayer-icon">{prayer.icon}</div>
            <div className="prayer-name">{prayer.name}</div>
            <div className="prayer-time">{times[prayer.key]}</div>
            <div className="prayer-description">{prayer.description}</div>
          </div>
        ))}
      </div>
    </div>
  );
};

// ูููู ูุนูููุงุช ุงูุทุฑููุฉ
const MethodInfo = ({ currentMethod }) => {
  const methodDetails = {
    MWL: { org: 'ุฑุงุจุทุฉ ุงูุนุงูู ุงูุฅุณูุงูู', fajr: '18ยฐ', isha: '17ยฐ' },
    ISNA: { org: 'ุงูุฌูุนูุฉ ุงูุฅุณูุงููุฉ ูุฃูุฑููุง ุงูุดูุงููุฉ', fajr: '15ยฐ', isha: '15ยฐ' },
    Egypt: { org: 'ุงูููุฆุฉ ุงููุตุฑูุฉ ุงูุนุงูุฉ ูููุณุงุญุฉ', fajr: '19.5ยฐ', isha: '17.5ยฐ' },
    Makkah: { org: 'ุฌุงูุนุฉ ุฃู ุงููุฑู', fajr: '18.5ยฐ', isha: '18.5ยฐ' },
    Karachi: { org: 'ุฌุงูุนุฉ ุงูุนููู ุงูุฅุณูุงููุฉ', fajr: '18ยฐ', isha: '18ยฐ' },
    Custom: { org: 'ุฅุนุฏุงุฏ ูุฎุตุต', fajr: 'ูุฎุตุต', isha: 'ูุฎุตุต' }
  };

  const details = methodDetails[currentMethod];

  return (
    <div className="method-info">
      <h4>๐ ุงูุทุฑููุฉ ุงูุญุงููุฉ: {currentMethod}</h4>
      <p><strong>ุงูููุธูุฉ:</strong> {details.org}</p>
      <p><strong>ุฒุงููุฉ ุงููุฌุฑ:</strong> {details.fajr} | <strong>ุฒุงููุฉ ุงูุนุดุงุก:</strong> {details.isha}</p>
    </div>
  );
};

// ูููู ูุคุดุฑ ุงูุชุญููู
const LoadingSpinner = () => (
  <div className="loading">
    <div className="spinner"></div>
    <p>ุฌุงุฑู ุญุณุงุจ ููุงููุช ุงูุตูุงุฉ...</p>
  </div>
);

// ูููู ุฑุณุงูุฉ ุงูุฎุทุฃ
const ErrorMessage = ({ message }) => (
  <div className="error-message">
    <p>โ {message}</p>
  </div>
);

// ุฎุทุงู ูุฎุตุต ูููุงููุช ุงูุตูุงุฉ
export const usePrayerTimes = (latitude, longitude, timezone, options, date) => {
  const [times, setTimes] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  useEffect(() => {
    if (!latitude || !longitude || !timezone) return;

    setLoading(true);
    setError(null);

    try {
      const sdk = new PrayerTimesSDK(latitude, longitude, date, timezone, options);
      const calculatedTimes = sdk.getTimes();
      setTimes(calculatedTimes);
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  }, [latitude, longitude, timezone, options, date]);

  return { times, loading, error };
};

// ูููู ุจุฏูู ุฃุจุณุท ุจุงุณุชุฎุฏุงู ุงูุฎุทุงู ุงููุฎุตุต
export const SimplePrayerTimes = ({ location, options }) => {
  const { times, loading, error } = usePrayerTimes(
    location.lat,
    location.lng,
    location.timezone,
    options,
    new Date()
  );

  if (loading) return <div>ุฌุงุฑู ุงูุชุญููู...</div>;
  if (error) return <div>ุฎุทุฃ: {error}</div>;
  if (!times) return <div>ูุง ุชูุฌุฏ ุจูุงูุงุช</div>;

  return (
    <div dir="rtl">
      <h2>ููุงููุช ุงูุตูุงุฉ</h2>
      <ul>
        <li>ุงููุฌุฑ: {times.fajr}</li>
        <li>ุงูุดุฑูู: {times.sunrise}</li>
        <li>ุงูุธูุฑ: {times.dhuhr}</li>
        <li>ุงูุนุตุฑ: {times.asr}</li>
        <li>ุงููุบุฑุจ: {times.maghrib}</li>
        <li>ุงูุนุดุงุก: {times.isha}</li>
      </ul>
    </div>
  );
};

// ุฃููุงุท CSS-in-JS (ููููู ุฃูุถุงู ุงุณุชุฎุฏุงู ููู CSS ูููุตู)
const styles = `
.prayer-times-app {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  direction: rtl;
}

.header {
  text-align: center;
  margin-bottom: 30px;
}

.header h1 {
  color: #2c3e50;
  margin-bottom: 10px;
}

.location-input, .options-panel, .date-selector {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 20px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.input-group {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
}

.input-field {
  margin-bottom: 15px;
}

.input-field label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
  color: #34495e;
}

.input-field input, .input-field select {
  width: 100%;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 5px;
  font-size: 16px;
  text-align: right;
}

.location-btn {
  background: #3498db;
  color: white;
  border: none;
  padding: 12px 20px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 16px;
  margin-top: 10px;
}

.location-btn:hover {
  background: #2980b9;
}

.times-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
}

.time-card {
  background: white;
  padding: 20px;
  border-radius: 10px;
  text-align: center;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  border: 2px solid #ecf0f1;
}

.time-card:hover {
  border-color: #3498db;
  transform: translateY(-2px);
  transition: all 0.3s ease;
}

.prayer-icon {
  font-size: 30px;
  margin-bottom: 10px;
}

.prayer-name {
  font-weight: bold;
  color: #2c3e50;
  margin-bottom: 5px;
}

.prayer-time {
  font-size: 24px;
  color: #e74c3c;
  font-weight: bold;
  margin-bottom: 5px;
}

.prayer-description {
  font-size: 12px;
  color: #7f8c8d;
}

.method-info {
  background: #e8f5e8;
  padding: 15px;
  border-radius: 5px;
  margin-top: 20px;
}

.loading {
  text-align: center;
  padding: 40px;
}

.spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #3498db;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.error-message {
  background: #fee;
  border: 1px solid #fcc;
  padding: 15px;
  border-radius: 5px;
  color: #c33;
  margin: 20px 0;
}

.custom-angles {
  background: #fff3cd;
  padding: 15px;
  border-radius: 5px;
  margin-top: 15px;
}
`;

// ุฅุถุงูุฉ ุงูุฃููุงุท ูููุณุชูุฏ (ูู ุชุทุจูู ุญููููุ ุณุชุณุชุฎุฏู CSS modules ุฃู styled-components)
if (typeof document !== 'undefined') {
  const styleSheet = document.createElement('style');
  styleSheet.textContent = styles;
  document.head.appendChild(styleSheet);
}

export default PrayerTimesApp;